<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial - Unnamed Admin</title>
    
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/header.css">
    <link rel="stylesheet" href="../assets/css/table-view.css">
    <style>
        .status-dot { font-weight: bold; font-size: 12px; }
        .in-campus { color: var(--success); }
        .out-campus { color: var(--text-muted); }
    </style>
</head>
<body>

    <header class="main-header"></header>

    <main class="page-content">
        
        <div class="page-header">
            <h2 class="page-title">Historial de Accesos</h2>
            
            <a href="simulador.html" class="btn btn-primary" style="background-color: var(--warning); border-color: var(--warning); color: #000;">
                ⚡ Simulador (Dev Mode)
            </a>
        </div>

        <div class="table-wrapper">
            <table id="historial-table">
                <thead>
                    <tr>
                        <th>Alumno</th>
                        <th>Boleta</th>
                        <th>Entrada</th>
                        <th>Salida</th>
                        <th>Método</th>
                    </tr>
                </thead>
                <tbody id="historial-tbody">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">Cargando historial...</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </main>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/header.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const tbody = document.getElementById('historial-tbody');
            try {
                const response = await apiFetch('/api/asistencia', 'GET');
                if(response.success) {
                    tbody.innerHTML = '';
                    if(response.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Sin registros.</td></tr>';
                        return;
                    }
                    response.data.forEach(h => {
                        const entrada = new Date(h.fecha_hora_entrada).toLocaleString();
                        const salida = h.fecha_hora_salida ? new Date(h.fecha_hora_salida).toLocaleString() : '--';
                        const status = h.fecha_hora_salida ? '<span class="status-dot out-campus">● Completado</span>' : '<span class="status-dot in-campus">● En Campus</span>';
                        
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>
                                <div class="user-cell">
                                    <img src="${h.imagen_url || '../assets/img/default-avatar.png'}" class="user-avatar">
                                    <div class="user-info">
                                        <span class="user-name">${h.nombres} ${h.apellido_paterno}</span>
                                        <span class="user-meta">${h.grupo || ''}</span>
                                    </div>
                                </div>
                            </td>
                            <td style="font-family:monospace;">${h.boleta}</td>
                            <td>${entrada}</td>
                            <td>${salida}</td>
                            <td>${h.metodo_entrada === 'manual' ? 'Manual' : 'QR App'} <br> ${status}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch(e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Error de conexión.</td></tr>';
            }
        });
    </script>

</body>
</html>