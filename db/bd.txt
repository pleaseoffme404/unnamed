CREATE DATABASE  IF NOT EXISTS `asistencia_escolar`;
USE `asistencia_escolar`;

CREATE TABLE IF NOT EXISTS `usuarios` (
    `id_usuario` INT AUTO_INCREMENT PRIMARY KEY,
    `correo_electronico` VARCHAR(255) NOT NULL UNIQUE,
    `contrasena_hash` VARCHAR(255) NOT NULL,
    `telefono` VARCHAR(20) UNIQUE,
    `rol` ENUM('admin', 'alumno', 'tutor') NOT NULL,
    `esta_activo` BOOLEAN DEFAULT true,
    `fecha_creacion` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS `perfil_admin` (
    `id_perfil_admin` INT AUTO_INCREMENT PRIMARY KEY,
    `id_usuario_fk` INT NOT NULL UNIQUE,
    `nombre_completo` VARCHAR(255) NOT NULL,
    `imagen_url` VARCHAR(255) NULL,
    FOREIGN KEY (`id_usuario_fk`) REFERENCES `usuarios`(`id_usuario`) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS `perfil_alumno` (
    `id_perfil_alumno` INT AUTO_INCREMENT PRIMARY KEY,
    `id_usuario_fk` INT NOT NULL UNIQUE,
    `nombres` VARCHAR(150) NOT NULL,
    `apellido_paterno` VARCHAR(100) NOT NULL,
    `apellido_materno` VARCHAR(100),
    `fecha_nacimiento` DATE,
    `curp` VARCHAR(18) NOT NULL UNIQUE,
    `nss` VARCHAR(20) UNIQUE,
    `tipo_sangre` VARCHAR(5),
    `grado` VARCHAR(20),
    `grupo` VARCHAR(10),
    `imagen_url` VARCHAR(255) NULL,
    `qr_token` VARCHAR(255) UNIQUE,
    FOREIGN KEY (`id_usuario_fk`) REFERENCES `usuarios`(`id_usuario`) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS `perfil_tutor` (
    `id_perfil_tutor` INT AUTO_INCREMENT PRIMARY KEY,
    `id_usuario_fk` INT NOT NULL UNIQUE,
    `nombres` VARCHAR(150) NOT NULL,
    `apellido_paterno` VARCHAR(100) NOT NULL,
    `apellido_materno` VARCHAR(100),
    `imagen_url` VARCHAR(255) NULL,
    `notificaciones` ENUM('ninguna', 'correo', 'ambas') DEFAULT 'correo',
    FOREIGN KEY (`id_usuario_fk`) REFERENCES `usuarios`(`id_usuario`) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS `vehiculos` (
    `id_vehiculo` INT AUTO_INCREMENT PRIMARY KEY,
    `id_perfil_alumno_fk` INT NOT NULL,
    `tipo` VARCHAR(100) NOT NULL,
    `descripcion` VARCHAR(255),
    `imagen_url` VARCHAR(255) NULL,
    `fecha_registro` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (`id_perfil_alumno_fk`) REFERENCES `perfil_alumno`(`id_perfil_alumno`) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS `alumnos_tutores` (
    `id_relacion` INT AUTO_INCREMENT PRIMARY KEY,
    `id_perfil_alumno_fk` INT NOT NULL,
    `id_perfil_tutor_fk` INT NOT NULL,
    `parentesco` VARCHAR(100) NOT NULL,
    FOREIGN KEY (`id_perfil_alumno_fk`) REFERENCES `perfil_alumno`(`id_perfil_alumno`) ON DELETE CASCADE,
    FOREIGN KEY (`id_perfil_tutor_fk`) REFERENCES `perfil_tutor`(`id_perfil_tutor`) ON DELETE CASCADE,
    UNIQUE KEY `idx_alumno_tutor` (`id_perfil_alumno_fk`, `id_perfil_tutor_fk`)
);

CREATE TABLE IF NOT EXISTS `asistencia` (
    `id_asistencia` INT AUTO_INCREMENT PRIMARY KEY,
    `id_perfil_alumno_fk` INT NOT NULL,
    `fecha_hora_entrada` TIMESTAMP NOT NULL,
    `fecha_hora_salida` TIMESTAMP NULL,
    `metodo_entrada` ENUM('qr', 'manual') DEFAULT 'qr',
    FOREIGN KEY (`id_perfil_alumno_fk`) REFERENCES `perfil_alumno`(`id_perfil_alumno`) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS `anuncios` (
    `id_anuncio` INT AUTO_INCREMENT PRIMARY KEY,
    `id_admin_fk` INT NOT NULL,
    `titulo` VARCHAR(255) NOT NULL,
    `contenido` TEXT NOT NULL,
    `destinatarios` ENUM('todos', 'solo_tutores', 'por_grado') DEFAULT 'todos',
    `fecha_publicacion` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (`id_admin_fk`) REFERENCES `perfil_admin`(`id_perfil_admin`)
);

CREATE TABLE IF NOT EXISTS `password_reset_tokens` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `id_usuario_fk` INT NOT NULL,
    `token` VARCHAR(255) NOT NULL UNIQUE,
    `expira_en` TIMESTAMP NOT NULL,
    FOREIGN KEY (`id_usuario_fk`) REFERENCES `usuarios`(`id_usuario`) ON DELETE CASCADE
);
INSERT INTO usuarios (correo_electronico, contrasena_hash, rol) 
VALUES (
    'admin@bullnodes.com',
    '$2a$10$dvrvjqcbGuSCuB0BBR7CPu37d8dUXo557xACc8w4WsGZ2VA07QMYy',
    'admin'
);

INSERT INTO perfil_admin (id_usuario_fk, nombre_completo) 
VALUES (
    (SELECT id_usuario FROM usuarios WHERE correo_electronico = 'admin@bullnodes.com'),
    'Administrador Principal'
);